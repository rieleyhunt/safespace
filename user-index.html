<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
    <title>SafeSpace: For Women</title>
  </head>
  <body>
    <!-- Adding a top bar here that will be reused -->
    <header class="top-bar">
      <div class="container-fluid d-flex justify-content-between align-items-center">
        <a href="index.html" class="text-white text-decoration-none fw-bold logo">SafeSpace</a>
        <div class="d-flex gap-2">
          <a href="about.html" class="top-bar-buttons">About us</a>
          <a href="profile.html" class="top-bar-buttons">Profile</a>
          <button onclick="logout()" class="top-bar-buttons" style="background: none; border: none; cursor: pointer;">Logout</button>
        </div>
      </div>
    </header>

    <div class="bg-image">
      <div class="container my-4 box-content">
        <h1>Locate a buddy</h1>
        <div class="box-body-content">
          <h1>MAP</h1>
          <div id="map" style="height: 400px; width: 100%; margin-top: 2rem;"></div>
          <div style="margin-bottom: 16px">
            <input
              type="text"
              id="destinationInput"
              placeholder="Enter your destination address"
              style="
                width: 70%;
                padding: 8px;
                border-radius: 6px;
                border: 1px solid #ccc;
              "
            />
          </div>
          <button
            id="findBuddyBtn"
            class="btn btn-primary"
            style="margin-top: 0"
          >
            Find Buddy
          </button>
          <div id="requestStatus" style="margin-top: 1rem; font-weight: bold;"></div>
        </div>
      </div>
    </div>
  </body>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSy993VOiMVlKygiJf587UwDDAmH0wUNA&libraries=places,marker"></script>
    <script type="module">
      import { supabase } from './auth-pages/supabaseClient.js';
      
      let currentUserId = null;
      let currentRequestId = null;
      
      async function logout() {
        try {
          const { error } = await supabase.auth.signOut();
          if (error) {
            console.error('Logout error:', error);
          }
          localStorage.removeItem('userType');
          localStorage.removeItem('user_id');
          window.location.href = '/index.html';
        } catch (error) {
          console.error('Logout failed:', error);
        }
      }
      
      // Make logout available globally
      window.logout = logout;
      
      // Start tracking user location when page loads
      async function startUserLocationTracking() {
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
          console.error('[USER] No authenticated user found');
          return;
        }
        
        currentUserId = user.id;
        console.log('[USER] User authenticated:', currentUserId);
        localStorage.setItem('user_id', currentUserId);
        
        if (navigator.geolocation) {
          // Get initial location and update database
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;
              
              await fetch('/user-location', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: currentUserId, lat, lon })
              });
              
              console.log('Initial user location updated');
            },
            (error) => {
              console.error('Error getting user location:', error);
            }
          );
          
          // Continuously track location
          navigator.geolocation.watchPosition(
            async (position) => {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;
              
              await fetch('/user-location', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: currentUserId, lat, lon })
              });
            },
            (error) => {
              console.error('Error tracking user location:', error);
            },
            { enableHighAccuracy: true }
          );
        }
      }
      
      // Listen for real-time updates on buddy request status
      function setupRealtimeListener() {
        const channel = supabase
          .channel('buddy-request-updates')
          .on(
            'postgres_changes',
            {
              event: 'UPDATE',
              schema: 'public',
              table: 'buddy_requests',
              filter: `user_id=eq.${currentUserId}`
            },
            (payload) => {
              console.log('Request status updated:', payload);
              const status = payload.new.status;
              const statusDiv = document.getElementById('requestStatus');
              
              if (status === 'accepted') {
                statusDiv.innerHTML = '<span style="color: green;">✓ Buddy accepted your request! Connection established.</span>';
              } else if (status === 'declined') {
                statusDiv.innerHTML = '<span style="color: red;">✗ Buddy declined your request. Try another buddy.</span>';
                currentRequestId = null;
              }
            }
          )
          .subscribe();
      }
      
      // Start tracking when page loads
      startUserLocationTracking();
      setupRealtimeListener();
      
      // Haversine distance calculation
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }
      
      // SIMPLIFIED: Use server endpoint for buddy matching (local in-memory matching)
      window.findNearbyBuddy = async function(userLat, userLng, radiusKm = 5) {
        try {
          console.log('[USER] Finding nearby buddies via server endpoint...');
          
          // Call simplified server endpoint that does in-memory matching
          const response = await fetch('/request-help', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lat: userLat, lng: userLng, radiusKm })
          });
          
          const data = await response.json();
          
          if (!data.success) {
            console.log('[USER] No buddy found:', data.message);
            return { success: false, message: data.message };
          }
          
          console.log('[USER] Found buddies:', data.buddies);
          // Return the buddies array for main.js to process
          return { 
            success: true, 
            buddies: data.buddies,  // This is what main.js expects
            volunteer: data.volunteer,  // Keep for backwards compatibility
            count: data.count 
          };
          
        } catch (err) {
          console.error('[USER] Error finding buddy:', err);
          return { success: false, message: 'Error connecting to server' };
        }
      };
      
      // Make findBuddy function available globally for main.js
      window.createBuddyRequest = async function(userLat, userLon, destLat, destLon, destination, buddyId) {
        if (!currentUserId) {
          console.error('[USER] User not authenticated - currentUserId is null');
          alert('User not authenticated');
          return null;
        }
        
        console.log('[USER] Creating request with:', {
          user_id: currentUserId,
          buddy_id: buddyId,
          user_lat: userLat,
          user_lon: userLon,
          destination
        });
        
        try {
          const { data, error } = await supabase
            .from('buddy_requests')
            .insert({
              user_id: currentUserId,
              buddy_id: buddyId,
              user_lat: userLat,
              user_lon: userLon,
              destination_lat: destLat,
              destination_lon: destLon,
              destination: destination,
              status: 'pending'
            })
            .select()
            .single();
          
          if (error) {
            console.error('[USER] Error creating request:', error);
            return null;
          }
          
          console.log('[USER] Request created in database:', data);
          currentRequestId = data.id;
          return data;
        } catch (err) {
          console.error('[USER] Failed to create buddy request:', err);
          return null;
        }
      };
    </script>
    <script src="main.js"></script>
</html>
