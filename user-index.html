<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
    <title>SafeSpace: For Women</title>
  </head>
  <body>
    <!-- Adding a top bar here that will be reused -->
    <header class="top-bar">
      <div class="container-fluid d-flex justify-content-between align-items-center">
        <a href="index.html" class="text-white text-decoration-none fw-bold logo">SafeSpace</a>
        <div class="d-flex gap-2">
          <a href="about.html" class="top-bar-buttons">About us</a>
          <a href="profile.html" class="top-bar-buttons">Profile</a>
          <button onclick="logout()" class="top-bar-buttons" style="background: none; border: none; cursor: pointer;">Logout</button>
        </div>
      </div>
    </header>

    <div class="bg-image">
      <div class="container my-4 box-content">
        <h1>Locate a buddy</h1>
        <div class="box-body-content">
          <h1>MAP</h1>
          <div id="map" style="height: 400px; width: 100%; margin-top: 2rem;"></div>
          <div style="margin-bottom: 16px">
            <input
              type="text"
              id="destinationInput"
              placeholder="Enter your destination address"
              style="
                width: 70%;
                padding: 8px;
                border-radius: 6px;
                border: 1px solid #ccc;
              "
            />
          </div>
          <button
            id="findBuddyBtn"
            class="btn btn-primary"
            style="margin-top: 0"
          >
            Find Buddy
          </button>
        </div>
      </div>
    </div>
  </body>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSy993VOiMVlKygiJf587UwDDAmH0wUNA&libraries=places"></script>
    <script type="module">
      import { supabase } from './auth-pages/supabaseClient.js';
      
      async function logout() {
        try {
          const { error } = await supabase.auth.signOut();
          if (error) {
            console.error('Logout error:', error);
          }
          localStorage.removeItem('userType');
          localStorage.removeItem('user_id');
          window.location.href = '/index.html';
        } catch (error) {
          console.error('Logout failed:', error);
        }
      }
      
      // Make logout available globally
      window.logout = logout;
      
      // Start tracking user location when page loads
      async function startUserLocationTracking() {
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
          console.error('No authenticated user found');
          return;
        }
        
        const user_id = user.id;
        localStorage.setItem('user_id', user_id);
        
        if (navigator.geolocation) {
          // Get initial location and update database
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;
              
              await fetch('/user-location', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id, lat, lon })
              });
              
              console.log('Initial user location updated');
            },
            (error) => {
              console.error('Error getting user location:', error);
            }
          );
          
          // Continuously track location
          navigator.geolocation.watchPosition(
            async (position) => {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;
              
              await fetch('/user-location', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id, lat, lon })
              });
            },
            (error) => {
              console.error('Error tracking user location:', error);
            },
            { enableHighAccuracy: true }
          );
        }
      }
      
      // Start tracking when page loads
      startUserLocationTracking();
    </script>
    <script src="main.js"></script>
</html>
