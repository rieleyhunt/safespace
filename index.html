<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SafeSpace: For Women</title>
        <link rel="stylesheet" href="styles.css">
        <!-- I'm adding bootstrap here. It is a very popular html library that is extremely useful -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    </head>
    <body>
        <!-- Adding a top bar here that will be reused -->
        <header class="top-bar">
            <div class="container-fluid d-flex justify-content-between align-items-center">
                <a href="index.html" class="text-white text-decoration-none fw-bold logo">SpaceSpace</a>
                <div class="d-flex gap-2">
                    <a href="about.html" class="top-bar-buttons">About us</a>
                    <button onclick="AUTH.logout()" class="top-bar-buttons" style="background: none; border: none; cursor: pointer;">Logout</button>
                </div>
            </div>
        </header>

        <div class="bg-image">
            <div class="container my-4 position-relative box-content" style="z-index: 1;">
                <h1>SafeSpace: For Women</h1>
                
                <div class="container box-body-content">
                    <p>üòÅ Safespace is a platform that provides a buddy system for women to ensure their safety while traveling alone</p>
                </div>

                <button id="btn" >Click me</button>
                        <a href="profile.html"> profile page </a>

            </div>
        </div>

        <!-- Attach all scripts here -->
        <script type="module">
          import { supabase } from './auth-pages/supabaseClient.js';
          
          // Make AUTH available globally
          window.AUTH = {
            async getSession() {
              const { data: { session } } = await supabase.auth.getSession();
              return session;
            },
            
            async getUser() {
              const { data: { user } } = await supabase.auth.getUser();
              return user;
            },
            
            async checkAuth() {
              try {
                const session = await this.getSession();
                return session !== null;
              } catch (error) {
                console.error('Auth check failed:', error);
                return false;
              }
            },
            
            async getUserProfile() {
              try {
                const user = await this.getUser();
                if (!user) return null;
                
                // Check if user is in users table
                const { data: userData } = await supabase
                  .from('users')
                  .select('*')
                  .eq('id', user.id)
                  .single();
                
                if (userData) {
                  return { ...userData, userType: 'user' };
                }
                
                // Check if user is in buddies table
                const { data: buddyData } = await supabase
                  .from('buddies')
                  .select('*')
                  .eq('id', user.id)
                  .single();
                
                if (buddyData) {
                  const { data: profileData } = await supabase
                    .from('buddy_profiles')
                    .select('*')
                    .eq('buddy_id', user.id)
                    .single();
                  
                  return { 
                    ...buddyData, 
                    profile: profileData,
                    userType: 'buddy' 
                  };
                }
                
                return null;
              } catch (error) {
                console.error('Get user profile failed:', error);
                return null;
              }
            },
            
            async logout() {
              try {
                const { error } = await supabase.auth.signOut();
                if (error) {
                  console.error('Logout error:', error);
                }
                localStorage.removeItem('userType');
              } catch (error) {
                console.error('Logout failed:', error);
              }
              window.location.href = '/auth-pages/login.html';
            }
          };
          
          // Protect this page - redirect if not authenticated
          (async () => {
            const isAuthenticated = await AUTH.checkAuth();
            if (!isAuthenticated) {
              window.location.href = '/auth-pages/login.html';
            }
          })();
        </script>
        <script src="main.js"></script>

        <!-- Bootstrap script, really useful for UI -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    </body>
</html>